# 单应矩阵

## 一、什么是单应矩阵

在计算机视觉中，平面的单应性被定义为从一个平面到另一个平面的投影映射。
设棋盘格π为空间中一平面，x=[X   Y   Z ]T为π上任意一点

1. 相机从某个角度拍摄该平面，点x在成像仪上的投影点q = [u  v  1]T，如果矩阵H使得下式成立：
		 q =sHx ，（其中s为非零常数因子）
则称H为平面π到成像仪图像平面的单应矩阵。

2. 相机从两个不同视角拍摄该平面得到的图像分别为I1和I2，x在图像上对应的投影点分别为U1 和 U2:
		U1=[u1  v1  1]T， U2=[u2  v2  1]T
如果矩阵H使得下式成立：
		U2=wHU1，（其中w为非零常数因子）							(1)
则称H为图像对(I1 ， I2)关于平面π的单应矩阵。

## 二、单应矩阵使用场景

比如图像校正、图像对齐或两幅图像之间的相机运动计算（旋转和平移）等。一旦旋转和平移从所估计的单应性矩阵中提取出来，那么该信息将可被用来导航或是把3D物体模型插入到图像或视频中，使其可根据正确的透视来渲染，并且成为原始场景的一部分。

## 三、单应矩阵的推导

#### 1. 单应和齐次坐标

一个单应矩阵是大小为3*3的矩阵H，满足给定一个点 
$$p_1=[x_1,y_1,w_1]^T $$
H把点p1变成一个新的点
$$p_2=[x_2,y_2.w_2]^T=Hp_1$$
注意由于它们都是齐次坐标，对应的图像上的两个点分别是
$$[\frac{x_1}{w_1},\frac{y_1}{w_1}]^T和[\frac{x_2}{w_2},\frac{y_2}{w_2}]^T$$

#### 2. 单应的自由度

如果给定一个单应
$$H=\{h_{ij}\}$$
给它的元素乘上同一个数a，得到的的单应aH和H作用相同，因为新单应无非把齐次点p1变成了齐次点ap2，ap2和p2对应的图像上的点相同。所以一个单应中只有8个自由元素，一般令右下角的那个元素h33=1来归一化。

#### 3. 求解单应

8个未知数，需要8个方程来求解，之所以四对点能够求解，是因为一对点提供两个方程。我们假设有两个图像上的点
$$
[x_1,y_1]^T ，[x_2,y_2]^T
$$
它们的齐次坐标为
$$
[x_1, y_1, 1]^T，[x_2, y_2, 1]^T
$$
带到上面的推导里可以得到：
$$
x_2=\frac{x_1h_{11}+y_1h_{12}+h_{13}}{x_1h_{31}+y_1h_{32}+1}
y_2=\frac{x_1h_{21}+y_1h_{22}+h_{23}}{x_1h_{31}+y_1h_{32}+1}
$$
把这两个式子重新组织一下，得到等价的矩阵形式：
$$
Au=v
$$
其中：
$$
A=[
\begin{array}{cccccccc}
x_1 & y_1 & 1 & 0 & 0 & 0 & -x_1x_2 & -x_2y_1\\
0 & 0 & 0 & x_1 & y_1 & 1 & -x_1y_2 & -y_1y_2
\end{array} ]
$$

$$
u=[
\begin{array}{cccccccc}
h_{11} & h_{12}&h_{13}&h_{21}&h_{22}&h_{23}&h_{31}&h_{32}
\end{array} ]^T
$$

$$
v=[
\begin{array}{cc}
x_2&y_2
\end{array} ]^T
$$

如果有四对不共线匹配点对，这个方程组就能够垒到8行，存在唯一解，如果多于四对点，比如有n对点，方程就垒到2n行，用最小二乘法或SVD分解就可以求解。

#### 四、程序实现

由于点对中可能存在不少错误匹配，因此往往需要使用RANSAC算法剔除错误匹配点对，整个流程在OpenCV中已经集成为函数 findhomography，输入点对坐标，输出单应和一个标记哪些点是正确匹配哪些点是错误匹配的数组。



